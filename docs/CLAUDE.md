# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**ktizo** (Greek: "to create," "to found," or "to form") is a PXE-based deployment system for Talos Linux on Kubernetes clusters. The project provides a web-based interface for managing cluster configuration, network settings, and device approval workflows.

## Architecture

### Backend (FastAPI)
- **Language**: Python 3.14 (preferred), 3.13, 3.12, or 3.11+
- **Framework**: FastAPI with SQLAlchemy ORM
- **Database**: SQLite (mounted at `./data/ktizo.db`)
- **Key Features**:
  - Cluster configuration management
  - Network settings for DNSMASQ
  - Device approval workflow with MAC address tracking
  - Talos configuration generation via `talosctl`
  - Jinja2 template rendering for configurations

### Frontend (Vue.js)
- **Framework**: Vue 3 with Vue Router
- **Build Tool**: Vite
- **Key Features**:
  - Network settings management
  - Cluster configuration interface
  - Device approval dashboard
  - Real-time configuration generation

### Infrastructure
- **DNSMASQ**: Provides DHCP, DNS, and TFTP services for PXE boot
- **Config Watcher**: Monitors configuration changes and reloads DNSMASQ automatically
- **Docker Compose**: Orchestrates all services with hot reload for development

## Directory Structure

```
ktizo/
├── backend/               # FastAPI application
│   ├── app/
│   │   ├── api/          # API route handlers
│   │   │   ├── cluster_router.py    # Cluster config & talosctl
│   │   │   ├── device_router.py     # Device approval workflow
│   │   │   ├── network_router.py    # Network settings
│   │   │   └── config_router.py     # Config generation
│   │   ├── crud/         # Database operations
│   │   ├── db/           # Database models and connection
│   │   ├── schemas/      # Pydantic models
│   │   └── services/     # Business logic (Jinja2 rendering)
│   └── Dockerfile
├── frontend/             # Vue.js application
│   ├── src/
│   │   ├── views/        # Page components
│   │   ├── services/     # API client
│   │   └── main.js       # App entry point
│   └── Dockerfile
├── templates/            # Jinja2 templates
│   ├── base/            # Base Talos configs (generated by talosctl)
│   ├── network/         # DNSMASQ templates
│   └── talos/           # Talos-specific templates
├── compiled/            # Rendered configurations (consumed by services)
│   ├── dnsmasq/         # DNSMASQ config files
│   └── pxe/             # PXE boot files
├── data/                # Persistent data (database)
│   └── ktizo.db         # SQLite database
└── docker-compose.yaml  # Service orchestration
```

## Development Environment

### Prerequisites
- Docker and Docker Compose
- Ports 8000, 5173, 53, 67, 69 available

### Running the Application

```bash
# Start all services
docker-compose up -d

# Rebuild after changes
docker-compose build backend
docker-compose up -d backend

# View logs
docker-compose logs -f backend
docker-compose logs -f frontend
```

### Accessing Services
- **Frontend**: http://localhost:5173
- **Backend API**: http://localhost:8000
- **API Docs**: http://localhost:8000/docs
- **DNSMASQ**: Ports 53 (DNS), 67 (DHCP), 69 (TFTP)

## Key Workflows

### 1. Cluster Configuration
1. Navigate to "Cluster Settings"
2. Configure cluster parameters (name, endpoint, external subnet, etc.)
3. Generate secrets or provide existing secrets
4. Click "Generate Cluster Configuration" to run `talosctl gen config`
5. Base configurations saved to `templates/base/`

### 2. Device Approval Workflow
See `DEVICE_WORKFLOW.md` for complete documentation.

**Summary:**
1. Device boots via PXE, iPXE loads Talos kernel with config URL parameter
2. Talos boots and calls the backend to register/download config (identified by MAC)
3. Device appears in "Device Management" with status PENDING
4. Administrator reviews and approves/rejects device
5. Once approved, Talos can download its customized configuration
6. Configurations are based on templates in `templates/base/` with per-device customization (hostname, IP)

### 3. Network Configuration
1. Navigate to "Network Settings"
2. Configure DNSMASQ parameters (server IP, DHCP range, TFTP settings)
3. Save and apply settings
4. Settings rendered to `compiled/dnsmasq/dnsmasq.conf`
5. Config watcher automatically reloads DNSMASQ

## Configuration Flow

```
User Input (Web UI)
  ↓
Backend (SQLite Database)
  ↓
Jinja2 Templates (templates/)
  ↓
Rendered Configs (compiled/)
  ↓
Services (DNSMASQ, Talos devices)
```

## Database Models

### ClusterSettings
- Cluster name, endpoint, external subnet
- Kubernetes version, install disk/image
- Network configuration (pod/service subnets, CNI, DNS)
- Talos secrets

### NetworkSettings
- DNSMASQ configuration parameters
- DHCP, DNS, TFTP settings
- PXE boot configuration

### Device
- MAC address (unique identifier)
- Hostname, IP address (optional)
- Role: controlplane or worker
- Status: pending, approved, rejected
- Approval timestamp, last config download time

## API Endpoints

### Cluster Management
- `GET /api/v1/cluster/settings` - Get cluster settings
- `POST /api/v1/cluster/settings` - Create cluster settings
- `PUT /api/v1/cluster/settings/{id}` - Update cluster settings
- `POST /api/v1/cluster/config/generate` - Generate Talos configs with talosctl
- `POST /api/v1/cluster/secrets/generate` - Generate secrets only

### Device Management
- `GET /api/v1/devices` - List devices (filterable by status)
- `POST /api/v1/devices` - Create device manually
- `PUT /api/v1/devices/{id}` - Update device
- `POST /api/v1/devices/{id}/approve` - Approve device
- `POST /api/v1/devices/{id}/reject` - Reject device
- `DELETE /api/v1/devices/{id}` - Delete device

### Device Boot Flow
- `POST /api/v1/devices/register` - Register device (called by Talos during boot)
- `POST /api/v1/config/download` - Download config (called by Talos via talos.config= kernel parameter)

### Network Management
- `GET /api/v1/network/settings` - Get network settings
- `POST /api/v1/network/settings` - Create network settings
- `PUT /api/v1/network/settings/{id}` - Update network settings
- `POST /api/v1/network/settings/apply` - Apply and render configs

## Important Notes

### Hot Reload
Both backend and frontend support hot reload during development:
- Backend: `uvicorn --reload` watches `app/` and `templates/`
- Frontend: Vite dev server watches `src/`
- DNSMASQ: Config watcher uses inotify to detect changes

### Database Persistence
The SQLite database is mounted at `./data/ktizo.db` and persists across container restarts.

### Talosctl Integration
The backend container includes talosctl v1.11.3 for generating Talos cluster configurations.

### Template System
- Jinja2 templates in `templates/` define configuration structure
- Rendered outputs in `compiled/` are consumed by services
- Base Talos configs in `templates/base/` are generated by talosctl
- Per-device customization applied at download time

## Future Enhancements

Planned improvements:
- iPXE boot script generation
- Bulk device approval
- Auto-approval rules based on MAC patterns
- Custom configuration templates per device group
- Webhook notifications for new devices
- Enhanced cluster monitoring and status
