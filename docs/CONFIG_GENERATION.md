# Configuration Generation Workflow

This document explains how Ktizo generates static Talos configuration files for approved devices.

## Overview

Ktizo uses a **static file generation** approach rather than dynamic API-based config serving. When a device is approved:

1. A static YAML config file is generated from base templates
2. The boot.ipxe script is regenerated with the device's MAC address mapping
3. When the device boots, iPXE matches its MAC and Talos fetches the pre-generated static config

## Directory Structure

```
ktizo/
├── templates/
│   ├── base/                    # Base configs from talosctl
│   │   ├── controlplane.yaml   # Generated by talosctl gen config
│   │   └── worker.yaml          # Generated by talosctl gen config
│   └── pxe/
│       └── boot.ipxe.j2         # iPXE boot script template
│
├── compiled/
│   ├── talos/
│   │   └── configs/             # Generated static configs
│   │       ├── controlplane-MAC1.yaml
│   │       ├── worker-MAC2.yaml
│   │       └── worker-MAC3.yaml
│   └── pxe/
│       └── boot.ipxe            # Generated iPXE script with MAC mappings
```

## Workflow Steps

### 1. Generate Base Configurations

**UI:** Cluster Settings → Generate Cluster Configuration

This runs `talosctl gen config` and creates:
- `templates/base/controlplane.yaml`
- `templates/base/worker.yaml`
- `templates/base/secrets.yaml`
- `templates/base/talosconfig`

These base configs contain cluster-wide settings like:
- Cluster name and endpoint
- Kubernetes version
- Network configuration (pod/service subnets)
- CNI settings
- Cluster secrets

### 2. Device Registration

When a device boots:
1. iPXE loads and reads the device's MAC address
2. iPXE checks the MAC against the approved device list in `boot.ipxe`
3. If not found, device boots to local disk (or exits)
4. If found, iPXE loads Talos with the appropriate config URL

### 3. Device Approval

**UI:** Device Management → Approve Device

When an administrator approves a device:

**Backend automatically:**
1. **Generates device-specific config** (`ConfigGenerator.generate_device_config()`):
   - Reads base config from `templates/base/controlplane.yaml` or `worker.yaml`
   - Parses YAML
   - Injects device-specific settings:
     - `machine.network.hostname` (if set)
     - `machine.network.interfaces[0].addresses` (if static IP set)
   - Writes to `compiled/talos/configs/{role}-{mac}.yaml`

2. **Regenerates boot.ipxe** (`IPXEGenerator.generate_boot_script()`):
   - Queries all approved devices from database
   - Renders `boot.ipxe.j2` template with device MAC→role→IP mappings
   - Writes to `compiled/pxe/boot.ipxe`
   - DNSMASQ serves this via TFTP

**Example Generated Config Filename:**
```
compiled/talos/configs/worker-6c:4b:90:8b:a1:6d.yaml
```

**Example boot.ipxe Entry:**
```ipxe
iseq ${mac} 6c:4b:90:8b:a1:6d && set node_role worker && set node_ip 10.0.128.2 && goto matched ||
```

### 4. Device Boot Process

When an approved device boots:

1. **PXE Boot** → DHCP provides boot info
2. **iPXE Loads** → Fetches `boot.ipxe` from TFTP
3. **MAC Matching** → iPXE checks MAC against approved list
4. **Match Found** → Sets `node_role` and `node_ip` variables
5. **Boot Menu** → User can choose install/boot local/wipe/shell
6. **Talos Loads** → iPXE loads kernel with config URL:
   ```
   talos.config=http://10.0.5.113/talos/configs/worker-6c:4b:90:8b:a1:6d.yaml
   ```
7. **Talos Fetches Config** → Downloads the pre-generated static file via HTTP
8. **Installation** → Talos installs using the customized configuration

## Configuration Customization

### Base Config (templates/base/)

**Example base worker.yaml:**
```yaml
machine:
  type: worker
  network:
    hostname: ""  # Will be customized
    interfaces: []  # Will be customized
cluster:
  name: my-cluster
  endpoint: https://10.0.5.100:6443
  # ... cluster-wide settings
```

### Device-Specific Config (compiled/talos/configs/)

**Example customized worker-MAC.yaml:**
```yaml
machine:
  type: worker
  network:
    hostname: worker-node-02
    interfaces:
      - addresses:
          - 10.0.128.2/24
cluster:
  name: my-cluster
  endpoint: https://10.0.5.100:6443
  # ... cluster-wide settings (unchanged from base)
```

## Automatic Regeneration Triggers

Configs are automatically regenerated when:

| Action | Device Config | boot.ipxe |
|--------|---------------|-----------|
| Device approved | ✓ Generated | ✓ Regenerated |
| Device rejected | ✓ Deleted | ✓ Regenerated |
| Device updated (if approved) | ✓ Regenerated | ✓ Regenerated |
| Device deleted | ✓ Deleted | ✓ Regenerated |

## Manual Regeneration

**API Endpoint:** `POST /api/v1/devices/regenerate`

Manually regenerate all configurations:
```bash
curl -X POST http://localhost:8000/api/v1/devices/regenerate
```

**Response:**
```json
{
  "message": "Configuration regeneration completed",
  "device_configs_generated": 5,
  "boot_script_generated": true,
  "approved_devices": 5
}
```

**Use cases:**
- After bulk device changes
- After modifying base templates
- Troubleshooting configuration issues
- After restoring from backup

## Configuration Serving

### HTTP API Endpoint

The FastAPI backend serves generated configs via a dedicated HTTP endpoint:
- **Route:** `GET /talos/configs/{mac_address}.yaml`
- **URL Pattern:** `http://{server}/talos/configs/{mac}.yaml`
- **Example:** `http://10.0.5.113/talos/configs/6c:4b:90:8b:a1:6d.yaml`

**How it works:**
1. Talos boots and requests config via HTTP GET with MAC address only
2. FastAPI route `/talos/configs/{mac}.yaml` receives request
3. Backend looks up device by MAC address in database to get role
4. Backend checks if device is approved in database
5. If approved: reads pre-generated config from `compiled/talos/configs/{role}-{mac}.yaml` and returns it
6. If not approved: returns 403 error (device registration is automatic)
7. Updates `last_config_download` timestamp in database

**Benefits:**
- Automatic device registration when config is requested
- Approval check before serving configuration
- Device role determined from database (not URL)
- Logging and monitoring of config downloads
- Dynamic error messages for troubleshooting

### TFTP Server

iPXE uses TFTP to download:
- Talos kernel: `tftp://{server}/talos/vmlinuz-amd64`
- Talos initramfs: `tftp://{server}/talos/initramfs-amd64.xz`
- Boot script: `tftp://{server}/pxe/boot.ipxe`

## Services

### ConfigGenerator (`app/services/config_generator.py`)

**Methods:**
- `generate_device_config(device)` - Generate config for one device
- `delete_device_config(device)` - Delete config for one device
- `regenerate_all_configs(devices)` - Regenerate all approved device configs

**Reads from:** `templates/base/{role}.yaml`
**Writes to:** `compiled/talos/configs/{role}-{mac}.yaml`

### IPXEGenerator (`app/services/ipxe_generator.py`)

**Methods:**
- `generate_boot_script(devices, server_ip, talos_version)` - Generate boot.ipxe

**Reads from:** `templates/pxe/boot.ipxe.j2`
**Writes to:** `compiled/pxe/boot.ipxe`

**Template Variables:**
- `server` - Server IP from network settings
- `version` - Talos version (default: v1.10.0)
- `devices` - List of approved devices with MAC, role, IP, hostname

## Troubleshooting

### Device boots but can't find config

**Symptom:** Talos logs show 404 when fetching config

**Causes:**
1. Device approved but config not generated
2. DNSMASQ not serving HTTP correctly
3. Wrong config URL format

**Solutions:**
```bash
# Check if config file exists
ls compiled/talos/configs/

# Manually regenerate configs
curl -X POST http://localhost:8000/api/v1/devices/regenerate

# Check DNSMASQ logs
docker-compose logs dnsmasq
```

### Device not matching in iPXE

**Symptom:** "Unknown MAC Address" message in iPXE

**Causes:**
1. Device not approved in database
2. boot.ipxe not regenerated
3. MAC address format mismatch

**Solutions:**
```bash
# Check device status in UI
# Approve device if pending

# Check generated boot.ipxe
cat compiled/pxe/boot.ipxe | grep "MAC"

# Manually regenerate
curl -X POST http://localhost:8000/api/v1/devices/regenerate
```

### Config has wrong hostname/IP

**Symptom:** Device installs with incorrect settings

**Causes:**
1. Device info not updated in database
2. Config not regenerated after update

**Solutions:**
1. Update device in UI (hostname, IP)
2. Config will auto-regenerate
3. Or manually regenerate: `POST /api/v1/devices/regenerate`

## Security Considerations

1. **Pre-approved only**: Only devices in the database with approved status can get configs
2. **Static files**: Configs are static YAML files, not dynamically generated per request
3. **No secrets in logs**: Secrets remain in base configs and compiled configs only
4. **File permissions**: Ensure compiled/ directory has appropriate permissions
5. **MAC as identifier**: Devices identified by MAC (can be spoofed on local network)
6. **Strict Boot Mode**: When disabled, unapproved devices may auto-wipe disks if no OS is found

### ⚠️ Critical Warning: Strict Boot Mode

**With Strict Boot Mode DISABLED (default):**
- Unapproved devices that fail to find a local OS will automatically enter the Talos installation menu
- If the default "Run" option is selected (or times out), Talos will install and **wipe the primary disk**
- This can result in **data loss** on devices that accidentally PXE boot

**Recommendation:**
- **Enable Strict Boot Mode in production environments** to prevent unintended installations
- With Strict Boot Mode enabled, unapproved devices immediately exit to the next BIOS boot device
- Configure in Network Settings → PXE Boot Configuration → Strict Boot Mode

## Best Practices

1. **Generate base configs first**: Always run `talosctl gen config` before approving devices
2. **Backup base configs**: Keep templates/base/ backed up (contains cluster secrets)
3. **Regenerate after bulk changes**: Use `/devices/regenerate` after mass updates
4. **Verify generated configs**: Check `compiled/talos/configs/` after approval
5. **Monitor logs**: Watch backend logs during approval for generation errors
6. **Version control**: Consider version controlling base templates (without secrets)
