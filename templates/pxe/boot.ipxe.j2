#!ipxe
# =====================================
# Talos PXE Boot (Auto-generated by Ktizo)
# =====================================

echo ========================================
echo Talos PXE Boot Script Starting
echo ========================================

set server {{ server }}
set version {{ version }}
set install_disk {{ install_disk }}

# Get MAC address â€” ${net0/mac} is the reliable iPXE way
# (${mac} is not always set, especially when loaded via PXE TFTP)
set mac ${net0/mac}
echo Detected MAC: ${mac}

# Ensure network interface is open
ifopen net0 ||

# Need DHCP for an IP to make HTTP registration call
dhcp net0 || echo [WARN] DHCP failed, continuing...

# Register this device with the Ktizo server (creates pending device if unknown)
imgfetch http://${server}:8000/pxe/register/${mac} && imgfree ||

set node_ip 0.0.0.0

echo ========================================
echo MAC Address Matching
echo ========================================

# --- MAC mapping (autogenerated from approved devices) ---
{% for device in devices %}
iseq ${mac} {{ device.mac_address }} && set node_ip {{ device.ip_address }} && echo MATCH: {{ device.mac_address }} -> {{ device.ip_address }} && goto matched ||
{% endfor %}
echo No match for MAC ${mac}
goto unknown

:matched
echo ========================================
echo Device Approved - Booting Talos
echo ========================================
echo MAC: ${mac}
echo IP: ${node_ip}
# Check if wipe flag is set for this device
{% for device in devices %}
iseq ${mac} {{ device.mac_address }} && {% if device.wipe_on_next_boot %}set wipe_flag 1 && echo WIPE FLAG SET - Device will be wiped on boot{% else %}set wipe_flag 0{% endif %} ||
{% endfor %}
isset wipe_flag || set wipe_flag 0
goto install_talos

:unknown
echo ========================================
echo Unknown Device: ${mac}
echo ========================================
echo This device is not approved.
echo Please add this device in the Ktizo web interface.
{% if strict_mode %}
echo Strict boot mode enabled - exiting...
sleep 3
exit
{% else %}
echo Strict mode disabled - attempting local boot...
sleep 3
goto boot_local
{% endif %}

# -------------------------------------------------------------------------------

:install_talos
echo ========================================
echo Installing Talos ${version}
echo ========================================

# Need DHCP for an IP to do TFTP/HTTP kernel loading
# (may already have IP from PXE discovery, but ensure it)
dhcp net0 || echo [WARN] DHCP failed, trying with existing config...

set cfg_url http://${server}:8000/talos/configs/${mac}.yaml
set kernel_url tftp://${server}/pxe/talos/vmlinuz-amd64-${version}
set initrd_url tftp://${server}/pxe/talos/initramfs-amd64-${version}.xz

echo Config: ${cfg_url}
echo Kernel: ${kernel_url}
echo Initrd: ${initrd_url}

echo Loading kernel...
# If wipe flag is set, notify the server so it resets the flag for next boot
iseq ${wipe_flag} 1 && echo Notifying server: wipe starting... && imgfetch http://${server}:8000/pxe/wipe-started/${mac} && imgfree ||

# Build kernel command line with conditional wipe parameter
iseq ${wipe_flag} 1 && kernel ${kernel_url} initrd=initramfs-amd64-${version}.xz \
 slab_nomerge pti=on \
 talos.platform=metal \
 talos.install=true \
 talos.install.disk=${install_disk} \
 talos.experimental.wipe=system \
 talos.config.url=${cfg_url} \
 talos.config=${cfg_url} || kernel ${kernel_url} initrd=initramfs-amd64-${version}.xz \
 slab_nomerge pti=on \
 talos.platform=metal \
 talos.install=true \
 talos.install.disk=${install_disk} \
 talos.config.url=${cfg_url} \
 talos.config=${cfg_url} || goto kernel_error

echo Loading initramfs...
initrd ${initrd_url} || goto initrd_error

echo ========================================
echo Booting Talos...
echo ========================================
boot

# -------------------------------------------------------------------------------

:boot_local
echo ========================================
echo Scanning for Bootable Drives
echo ========================================
sanboot --no-describe --drive 0x80 || goto try_81
:try_81
sanboot --no-describe --drive 0x81 || goto try_82
:try_82
sanboot --no-describe --drive 0x82 || goto try_83
:try_83
sanboot --no-describe --drive 0x83 || goto auto_install
goto auto_install

:auto_install
echo No bootable OS found - auto-installing Talos...
sleep 3
goto install_talos

# -------------------------------------------------------------------------------

:boot_menu
menu Talos Boot Menu - ${node_ip}
item --gap --             Boot Options:
item --key i run          Run PXE Installation Media of Talos ${version} (default)
item --key b boot_local   Boot from local disk
item --key d wipe         Wipe local disk installation
item --key s shell        iPXE Shell
item --gap --
choose --timeout 10000 --default run selected || set selected run
iseq ${selected} run && goto install_talos
iseq ${selected} boot_local && goto boot_local
iseq ${selected} wipe && goto wipe
iseq ${selected} shell && goto shell
goto install_talos

# -------------------------------------------------------------------------------

:wipe
echo ========================================
echo Wiping Operating System
echo ========================================
dhcp net0 || echo [WARN] DHCP failed...

set cfg_url http://${server}:8000/talos/configs/${mac}.yaml
set kernel_url tftp://${server}/pxe/talos/vmlinuz-amd64-${version}
set initrd_url tftp://${server}/pxe/talos/initramfs-amd64-${version}.xz

kernel ${kernel_url} initrd=initramfs-amd64-${version}.xz \
 slab_nomerge pti=on \
 talos.platform=metal \
 talos.install=false \
 talos.experimental.wipe=system \
 talos.config.url=${cfg_url} \
 talos.config=${cfg_url} || goto kernel_error

initrd ${initrd_url} || goto initrd_error
boot

# -------------------------------------------------------------------------------

:shell
echo Type 'exit' to return to menu
shell
goto boot_menu

:kernel_error
echo ========================================
echo ERROR: Kernel Load Failed
echo ========================================
echo Failed to load: ${kernel_url}
echo Ensure vmlinuz-amd64-${version} exists on TFTP server
sleep 10
exit

:initrd_error
echo ========================================
echo ERROR: Initrd Load Failed
echo ========================================
echo Failed to load: ${initrd_url}
echo Ensure initramfs-amd64-${version}.xz exists on TFTP server
sleep 10
exit
