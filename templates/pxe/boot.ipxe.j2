#!ipxe
# =====================================
# Talos PXE Boot (Auto-generated by Ktizo)
# =====================================

# Prevent infinite loops - if we've already run, exit
isset booted_from_ipxe && exit || set booted_from_ipxe 1

echo ========================================
echo Talos PXE Boot Script Starting
echo ========================================

echo [DEBUG] Setting variables...
set server {{ server }}
set version {{ version }}
set install_disk {{ install_disk }}
echo [DEBUG] Server: ${server}
echo [DEBUG] Version: ${version}
echo [DEBUG] Install disk: ${install_disk}

echo ========================================
echo === Talos ${version} PXE Boot ===
echo ========================================

echo [DEBUG] Reading MAC address...
echo Detected MAC: ${mac}

echo [DEBUG] Initializing variables...
set node_ip 0.0.0.0

echo [DEBUG] Opening network interface...
# Try to open network interface, but don't fail if already open
ifstat net0 || ifopen net0 || echo [DEBUG] Network interface already open or failed to open
echo [DEBUG] Network interface ready

echo ========================================
echo MAC Address Matching
echo ========================================

# --- MAC mapping (autogenerated from approved devices) ---
{% for device in devices %}
echo [DEBUG] Checking if MAC matches {{ device.mac_address }}...
iseq ${mac} {{ device.mac_address }} && set node_ip {{ device.ip_address }} && echo [DEBUG] MATCH FOUND: {{ device.ip_address }} && goto matched ||
{% endfor %}
echo [DEBUG] No MAC match found, going to unknown handler
goto unknown

:matched
echo ========================================
echo MAC Match Found!
echo ========================================
echo Matched IP: ${node_ip}
echo
goto boot_menu

:unknown
echo ========================================
echo Unknown MAC Address
echo ========================================
echo Unknown MAC: ${mac}
echo This device is not approved.
echo Please add this device in the Ktizo web interface.
{% if strict_mode %}
echo Strict boot mode enabled - exiting to next boot device...
exit
{% else %}
echo WARNING: Strict mode is disabled.
echo Attempting local boot...
echo If no OS is found, automatic installation may wipe this disk!
sleep 3
goto boot_local
{% endif %}

:boot_menu
menu Talos Boot Menu - ${node_ip}
item --gap --             Boot Options:
item --key i run          Run PXE Installation Media of Talos ${version} (default)
item --key b boot_local   Boot from local disk
item --key d wipe         Wipe local disk installation
item --key s shell        iPXE Shell
item --gap --
choose --timeout 10000 --default run selected || set selected run
# Validate menu selection to prevent invalid goto
iseq ${selected} run && goto run
iseq ${selected} boot_local && goto boot_local
iseq ${selected} wipe && goto wipe
iseq ${selected} shell && goto shell
# Default fallback
goto run

# -------------------------------------------------------------------------------

:boot_local
echo ========================================
echo Scanning for Bootable Drives
echo ========================================
goto try_drive_0x80

:try_drive_0x80
echo [DEBUG] Attempt 1/4: Trying drive 0x80 (first hard drive)...
sanboot --no-describe --drive 0x80 || goto try_drive_0x81
# If sanboot succeeds, it boots and never returns here

:try_drive_0x81
echo [DEBUG] Drive 0x80 not bootable
echo [DEBUG] Attempt 2/4: Trying drive 0x81 (second hard drive)...
sanboot --no-describe --drive 0x81 || goto try_drive_0x82
# If sanboot succeeds, it boots and never returns here

:try_drive_0x82
echo [DEBUG] Drive 0x81 not bootable
echo [DEBUG] Attempt 3/4: Trying drive 0x82 (third hard drive)...
sanboot --no-describe --drive 0x82 || goto try_drive_0x83
# If sanboot succeeds, it boots and never returns here

:try_drive_0x83
echo [DEBUG] Drive 0x82 not bootable
echo [DEBUG] Attempt 4/4: Trying drive 0x83 (fourth hard drive)...
sanboot --no-describe --drive 0x83 || goto auto_install
# If sanboot succeeds, it boots and never returns here
echo [DEBUG] Drive 0x83 not bootable
echo [DEBUG] All drives attempted, none bootable
goto auto_install

# -------------------------------------------------------------------------------

:auto_install
echo ========================================
echo No Existing Installation Found
echo ========================================
echo [DEBUG] No bootable OS detected on any drive
echo [DEBUG] Auto-installing Talos in 3 seconds...
sleep 3
goto install_talos

# -------------------------------------------------------------------------------

:run
echo ========================================
echo PXE Run Selected
echo ========================================
echo [DEBUG] User requested Talos installation
goto install_talos

# -------------------------------------------------------------------------------

:install_talos
echo ========================================
echo Installing Talos ${version}
echo ========================================
echo IP: ${node_ip}

set cfg_url http://${server}/talos/configs/${mac}.yaml
echo Config URL: ${cfg_url}

set kernel_url tftp://${server}/pxe/talos/vmlinuz-amd64-${version}
set initrd_url tftp://${server}/pxe/talos/initramfs-amd64-${version}.xz

echo [DEBUG] Kernel URL: ${kernel_url}
echo [DEBUG] Initrd URL: ${initrd_url}

echo [DEBUG] Loading kernel...
kernel ${kernel_url} initrd=initramfs-amd64-${version}.xz \
 slab_nomerge pti=on \
 talos.platform=metal \
 talos.install=true \
 talos.install.disk=${install_disk} \
 talos.config.url=${cfg_url} \
 talos.config=${cfg_url} || goto kernel_error

echo [DEBUG] Loading initramfs...
initrd ${initrd_url} || goto initrd_error

echo [DEBUG] Starting Talos installation...
echo ========================================
boot

# -------------------------------------------------------------------------------

:wipe
echo ========================================
echo Wiping Operating System
echo ========================================
set cfg_url http://${server}/talos/configs/${mac}.yaml
echo Config URL: ${cfg_url}

set kernel_url tftp://${server}/pxe/talos/vmlinuz-amd64-${version}
set initrd_url tftp://${server}/pxe/talos/initramfs-amd64-${version}.xz

kernel ${kernel_url} initrd=initramfs-amd64-${version}.xz \
 slab_nomerge pti=on \
 talos.platform=metal \
 talos.install=false \
 talos.experimental.wipe=system \
 talos.config.url=${cfg_url} \
 talos.config=${cfg_url} || goto kernel_error

echo [DEBUG] Loading initramfs...
initrd ${initrd_url} || goto initrd_error

echo [DEBUG] Starting Wipe...
echo ========================================
boot

# -------------------------------------------------------------------------------

:shell
echo ========================================
echo iPXE Shell
echo ========================================
echo Type 'exit' to return to menu
shell
goto boot_menu

:kernel_error
echo ========================================
echo ERROR: Kernel Load Failed
echo ========================================
echo Failed to load: ${kernel_url}
echo Check if vmlinuz-amd64-${version} exists in /var/lib/tftpboot/pxe/talos/
echo
echo Exiting to prevent boot loop...
sleep 5
exit

:initrd_error
echo ========================================
echo ERROR: Initrd Load Failed
echo ========================================
echo Failed to load: ${initrd_url}
echo Check if initramfs-amd64-${version}.xz exists in /var/lib/tftpboot/pxe/talos/
echo
echo Exiting to prevent boot loop...
sleep 5
exit
