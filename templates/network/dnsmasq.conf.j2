# /etc/dnsmasq.d/pxe.conf
# Simplified iPXE PXE Boot Configuration
# Generated by Ktizo

{% if interface -%}
# Listen on specific interface
interface={{ interface }}
{% endif %}

# Enable DHCP logging for debugging
{% if enable_logging | default(true) -%}
log-dhcp
{% endif %}

{% if dhcp_mode == "proxy" -%}
# ProxyDHCP configuration - listen but don't assign IPs
dhcp-range={{ dhcp_network | default('10.0.0.0') }},proxy,{{ dhcp_netmask | default('255.255.0.0') }}
{% else -%}
# Full DHCP Server mode - assign IPs
dhcp-range={{ dhcp_range_start }},{{ dhcp_range_end }},{{ dhcp_netmask | default('255.255.0.0') }},12h
{% endif %}

# Disable DNS resolution (we're only doing DHCP/PXE)
port={{ dns_port | default(0) }}

# Enable built-in TFTP server
enable-tftp
tftp-root={{ tftp_root | default('/srv/tftp') }}
{% if tftp_secure | default(true) -%}
tftp-secure
{% endif %}

# Detect if client is already running iPXE (multiple detection methods)
dhcp-match=set:ipxe,175
dhcp-userclass=set:ipxe,iPXE
dhcp-vendorclass=set:ipxe,iPXE

# Architecture detection
dhcp-match=set:bios,option:client-arch,0
dhcp-match=set:efi32,option:client-arch,6
dhcp-match=set:efi64,option:client-arch,7
dhcp-match=set:efi64-alt,option:client-arch,9
dhcp-match=set:efi-arm32,option:client-arch,10
dhcp-match=set:efi-arm64,option:client-arch,11

# PXE menu prompt settings (only for non-iPXE clients)
# iPXE clients should auto-chainload, so no prompt needed
dhcp-option-force=tag:!ipxe,208,f1:00:74:7e:00:00
pxe-prompt=tag:!ipxe,"{{ pxe_prompt | default('Press F8 for boot menu') }}", {{ pxe_timeout | default(3) }}

# PXE service types (only for non-iPXE clients)
# NOTE: Use chainboot bootloaders to prevent iPXE loops
# These bootloaders have embedded scripts that auto-chain to boot.ipxe
pxe-service=tag:!ipxe,x86PC,"Boot from network (PXE)",pxe/undionly-chainboot.kpxe
pxe-service=tag:!ipxe,x86-64_EFI,"Boot from network (UEFI)",pxe/ipxe-chainboot.efi
pxe-service=tag:!ipxe,BC_EFI,"Boot from network (UEFI)",pxe/ipxe-chainboot.efi

# ====================
# BOOT FILE LOGIC (SIMPLIFIED)
# ====================

# If client already has iPXE loaded → send boot.ipxe directly
# Use HTTP URL for better iPXE auto-execution (iPXE auto-executes HTTP-loaded scripts)
# Format: http://server-ip:8000/path/to/boot.ipxe (backend serves on port 8000)
set ipxe_script_path={{ ipxe_boot_script | default('pxe/boot.ipxe') }}
dhcp-boot=tag:ipxe,http://{{ server_ip }}:8000/{{ ipxe_boot_script | default('pxe/boot.ipxe') }}
dhcp-option=tag:ipxe,67,http://{{ server_ip }}:8000/{{ ipxe_boot_script | default('pxe/boot.ipxe') }}

# If client doesn't have iPXE yet → send custom chainboot bootloader
# Custom bootloader has embedded script that auto-loads boot.ipxe
# Legacy BIOS (x86) - use chainboot version if available, fallback to standard
dhcp-boot=tag:!ipxe,tag:bios,pxe/undionly-chainboot.kpxe
dhcp-boot=tag:!ipxe,tag:bios,pxe/undionly.kpxe

# UEFI (all architectures - generic iPXE EFI binary)
dhcp-boot=tag:!ipxe,tag:efi32,pxe/ipxe.efi
dhcp-boot=tag:!ipxe,tag:efi64,pxe/ipxe.efi
dhcp-boot=tag:!ipxe,tag:efi64-alt,pxe/ipxe.efi
dhcp-boot=tag:!ipxe,tag:efi-arm32,pxe/ipxe.efi
dhcp-boot=tag:!ipxe,tag:efi-arm64,pxe/ipxe.efi

# Fallback for unrecognized architectures
dhcp-boot=tag:!ipxe,pxe/ipxe.pxe

# ====================
# ADDITIONAL OPTIONS
# ====================

# TFTP server location
dhcp-option=option:tftp-server,{{ server_ip }}
dhcp-option=66,{{ server_ip }}
dhcp-option=option:server-ip-address,{{ server_ip }}

# DNS server (optional)
{% if dns_server -%}
dhcp-option-force=option:dns-server,{{ dns_server }}
{% else -%}
dhcp-option-force=option:dns-server,{{ server_ip }}
{% endif %}

dhcp-authoritative
