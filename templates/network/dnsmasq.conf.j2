# /etc/dnsmasq.d/pxe.conf
# iPXE PXE Boot Configuration
# Generated by Ktizo

{% if interface -%}
# Listen on specific interface
interface={{ interface }}
{% endif %}

# Enable DHCP logging for debugging
{% if enable_logging | default(true) -%}
log-dhcp
{% endif %}

{% if dhcp_mode == "proxy" -%}
# ProxyDHCP configuration - listen but don't assign IPs
dhcp-range={{ dhcp_network | default('10.0.0.0') }},proxy,{{ dhcp_netmask | default('255.255.0.0') }}
{% else -%}
# Full DHCP Server mode - assign IPs
dhcp-range={{ dhcp_range_start }},{{ dhcp_range_end }},{{ dhcp_netmask | default('255.255.0.0') }},12h
{% endif %}

# Disable DNS resolution (we're only doing DHCP/PXE)
port={{ dns_port | default(0) }}

# Enable built-in TFTP server
enable-tftp
tftp-root={{ tftp_root | default('/srv/tftp') }}
{% if tftp_secure | default(true) -%}
tftp-secure
{% endif %}

# Detect if client is already running iPXE
dhcp-userclass=set:ipxe,iPXE
dhcp-match=set:ipxe,175
dhcp-vendorclass=set:ipxe,iPXE

# Architecture detection
dhcp-match=set:bios,option:client-arch,0
dhcp-match=set:efi32,option:client-arch,6
dhcp-match=set:efi64,option:client-arch,7
dhcp-match=set:efi64-alt,option:client-arch,9
dhcp-match=set:efi-arm32,option:client-arch,10
dhcp-match=set:efi-arm64,option:client-arch,11

# ====================
# PXE BOOT SERVICES
# ====================
# In proxy DHCP mode, pxe-service is the PRIMARY mechanism for booting.
#
# ALL clients get the chainboot bootloader binary. This works for:
# - Non-iPXE clients: chainboot loads iPXE + embedded script auto-chains to boot.ipxe
# - iPXE clients (e.g. Proxmox VMs with built-in iPXE): chainboot starts a fresh
#   iPXE instance with embedded script that auto-chains to boot.ipxe via HTTP.
#   No loop risk because the embedded script uses a hardcoded HTTP URL (not PXE discovery).
#
# pxe-service MUST serve a real binary (NBP), not a .ipxe script â€” iPXE cannot
# execute scripts delivered via PXE service discovery.

pxe-prompt="{{ pxe_prompt | default('Press F8 for boot menu') }}", {{ pxe_timeout | default(3) }}

# iPXE clients: serve boot.ipxe script directly via TFTP
# iPXE recognizes #!ipxe shebang and executes it as a script
pxe-service=tag:ipxe,x86PC,"Talos PXE Boot",pxe/boot.ipxe
pxe-service=tag:ipxe,x86-64_EFI,"Talos PXE Boot",pxe/boot.ipxe
pxe-service=tag:ipxe,BC_EFI,"Talos PXE Boot",pxe/boot.ipxe

# Non-iPXE clients: serve chainboot binary (loads iPXE + embedded script)
pxe-service=tag:!ipxe,x86PC,"Talos PXE Boot",pxe/undionly-chainboot.kpxe
pxe-service=tag:!ipxe,x86-64_EFI,"Talos PXE Boot (UEFI)",pxe/ipxe-chainboot.efi
pxe-service=tag:!ipxe,BC_EFI,"Talos PXE Boot (UEFI)",pxe/ipxe-chainboot.efi

# ====================
# DHCP BOOT FILES (fallback / non-proxy mode)
# ====================
# In non-proxy mode, dhcp-boot is used instead of pxe-service.
# iPXE clients can chain HTTP URLs directly, so serve boot.ipxe via HTTP.
# Non-iPXE clients get chainboot binaries.

dhcp-boot=tag:ipxe,http://{{ server_ip }}:8000/{{ ipxe_boot_script | default('pxe/boot.ipxe') }}

dhcp-boot=tag:!ipxe,tag:bios,pxe/undionly-chainboot.kpxe
dhcp-boot=tag:!ipxe,tag:bios,pxe/undionly.kpxe
dhcp-boot=tag:!ipxe,tag:efi32,pxe/ipxe-chainboot.efi
dhcp-boot=tag:!ipxe,tag:efi64,pxe/ipxe-chainboot.efi
dhcp-boot=tag:!ipxe,tag:efi64-alt,pxe/ipxe-chainboot.efi
dhcp-boot=tag:!ipxe,tag:efi-arm32,pxe/ipxe-chainboot.efi
dhcp-boot=tag:!ipxe,tag:efi-arm64,pxe/ipxe-chainboot.efi
dhcp-boot=tag:!ipxe,tag:efi32,pxe/ipxe.efi
dhcp-boot=tag:!ipxe,tag:efi64,pxe/ipxe.efi
dhcp-boot=tag:!ipxe,tag:efi64-alt,pxe/ipxe.efi
dhcp-boot=tag:!ipxe,tag:efi-arm32,pxe/ipxe.efi
dhcp-boot=tag:!ipxe,tag:efi-arm64,pxe/ipxe.efi
dhcp-boot=tag:!ipxe,pxe/ipxe.pxe

# ====================
# ADDITIONAL OPTIONS
# ====================

# TFTP server location
dhcp-option=option:tftp-server,{{ server_ip }}
dhcp-option=66,{{ server_ip }}
dhcp-option=option:server-ip-address,{{ server_ip }}

# DNS server (optional)
{% if dns_server -%}
dhcp-option-force=option:dns-server,{{ dns_server }}
{% else -%}
dhcp-option-force=option:dns-server,{{ server_ip }}
{% endif %}

dhcp-authoritative
