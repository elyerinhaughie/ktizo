# /etc/dnsmasq.d/pxe.conf
# Simplified iPXE PXE Boot Configuration
# Generated by Ktizo

{% if interface -%}
# Listen on specific interface
interface={{ interface }}
{% endif %}

# Enable DHCP logging for debugging
{% if enable_logging | default(true) -%}
log-dhcp
{% endif %}

{% if dhcp_mode == "proxy" -%}
# ProxyDHCP configuration - listen but don't assign IPs
dhcp-range={{ dhcp_network | default('10.0.0.0') }},proxy,{{ dhcp_netmask | default('255.255.0.0') }}
{% else -%}
# Full DHCP Server mode - assign IPs
dhcp-range={{ dhcp_range_start }},{{ dhcp_range_end }},{{ dhcp_netmask | default('255.255.0.0') }},12h
{% endif %}

# Disable DNS resolution (we're only doing DHCP/PXE)
port={{ dns_port | default(0) }}

# Enable built-in TFTP server
enable-tftp
tftp-root={{ tftp_root | default('/srv/tftp') }}
{% if tftp_secure | default(true) -%}
tftp-secure
{% endif %}

# Detect if client is already running iPXE
# Primary method: user-class = "iPXE" (most reliable)
dhcp-userclass=set:ipxe,iPXE
# Fallback: DHCP option 175 (iPXE vendor identifier)
dhcp-match=set:ipxe,175
# Additional fallback: vendor-class (some iPXE variants)
dhcp-vendorclass=set:ipxe,iPXE

# Architecture detection
dhcp-match=set:bios,option:client-arch,0
dhcp-match=set:efi32,option:client-arch,6
dhcp-match=set:efi64,option:client-arch,7
dhcp-match=set:efi64-alt,option:client-arch,9
dhcp-match=set:efi-arm32,option:client-arch,10
dhcp-match=set:efi-arm64,option:client-arch,11

# PXE menu prompt settings (only for non-iPXE clients)
# iPXE clients should auto-chainload, so no prompt needed
dhcp-option-force=tag:!ipxe,208,f1:00:74:7e:00:00
pxe-prompt=tag:!ipxe,"{{ pxe_prompt | default('Press F8 for boot menu') }}", {{ pxe_timeout | default(3) }}

# PXE service types (only for non-iPXE clients)
# NOTE: Use chainboot bootloaders to prevent iPXE loops
# These bootloaders have embedded scripts that auto-chain to boot.ipxe
pxe-service=tag:!ipxe,x86PC,"Boot from network (PXE)",pxe/undionly-chainboot.kpxe
pxe-service=tag:!ipxe,x86-64_EFI,"Boot from network (UEFI)",pxe/ipxe-chainboot.efi
pxe-service=tag:!ipxe,BC_EFI,"Boot from network (UEFI)",pxe/ipxe-chainboot.efi

# ====================
# BOOT FILE LOGIC (SIMPLIFIED)
# ====================

# ====================
# BOOT FILE LOGIC (State Machine)
# ====================
# Rule: NEVER deliver iPXE binary to clients already running iPXE
# 
# State: IS iPXE → deliver script (boot.ipxe via HTTP)
# State: NOT iPXE → deliver iPXE binary (undionly.kpxe or ipxe.efi)

# If client already has iPXE loaded → send boot.ipxe script directly
# iPXE auto-executes HTTP-loaded scripts, so no chainloading needed
# Use HTTP (not TFTP) for better performance and reliability
dhcp-boot=tag:ipxe,http://{{ server_ip }}:8000/{{ ipxe_boot_script | default('pxe/boot.ipxe') }}
dhcp-option=tag:ipxe,67,http://{{ server_ip }}:8000/{{ ipxe_boot_script | default('pxe/boot.ipxe') }}

# If client doesn't have iPXE yet → send iPXE binary
# Use chainboot versions that have embedded scripts to auto-load boot.ipxe
# This prevents loops and ensures deterministic boot flow

# Legacy BIOS (x86) - use chainboot bootloader with embedded script
dhcp-boot=tag:!ipxe,tag:bios,pxe/undionly-chainboot.kpxe
# Fallback to standard if chainboot not available
dhcp-boot=tag:!ipxe,tag:bios,pxe/undionly.kpxe

# UEFI (all architectures) - use chainboot EFI with embedded script
dhcp-boot=tag:!ipxe,tag:efi32,pxe/ipxe-chainboot.efi
dhcp-boot=tag:!ipxe,tag:efi64,pxe/ipxe-chainboot.efi
dhcp-boot=tag:!ipxe,tag:efi64-alt,pxe/ipxe-chainboot.efi
dhcp-boot=tag:!ipxe,tag:efi-arm32,pxe/ipxe-chainboot.efi
dhcp-boot=tag:!ipxe,tag:efi-arm64,pxe/ipxe-chainboot.efi
# Fallback to standard if chainboot not available
dhcp-boot=tag:!ipxe,tag:efi32,pxe/ipxe.efi
dhcp-boot=tag:!ipxe,tag:efi64,pxe/ipxe.efi
dhcp-boot=tag:!ipxe,tag:efi64-alt,pxe/ipxe.efi
dhcp-boot=tag:!ipxe,tag:efi-arm32,pxe/ipxe.efi
dhcp-boot=tag:!ipxe,tag:efi-arm64,pxe/ipxe.efi

# Fallback for unrecognized architectures
dhcp-boot=tag:!ipxe,pxe/ipxe.pxe

# ====================
# ADDITIONAL OPTIONS
# ====================

# TFTP server location
dhcp-option=option:tftp-server,{{ server_ip }}
dhcp-option=66,{{ server_ip }}
dhcp-option=option:server-ip-address,{{ server_ip }}

# DNS server (optional)
{% if dns_server -%}
dhcp-option-force=option:dns-server,{{ dns_server }}
{% else -%}
dhcp-option-force=option:dns-server,{{ server_ip }}
{% endif %}

dhcp-authoritative
